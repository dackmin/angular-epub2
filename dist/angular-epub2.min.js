/*! angular-epub2 v1.0.1 02/11/2015 */
(function(){"use strict";angular.module("epub2",[]).service("$epub2",function($q){return this.handler=null,this.add_container_file=function(){var file;return file='<?xml version="1.0" encoding="UTF-8"?>\n<container version="1.0" xmlns="urn:oasis:names:tc:opendocument:xmlns:container">\n    <rootfiles>\n        <rootfile full-path="OEBPS/content.opf" media-type="application/oebps-package+xml"/>\n   </rootfiles>\n</container>',this.handler.file("META-INF/container.xml",file)},this.add_mimetype_file=function(){var file;return file="application/epub+zip",this.handler.file("mimetype",file)},this.add_map_file=function(book){var chapter,file,key;return file='<?xml version="1.0" encoding="utf-8"?>\n<ncx xmlns="http://www.daisy.org/z3986/2005/ncx/" version="2005-1">\n    <head>\n        <meta content="'+book.ean+'" name="dtb:uid"/>\n        <meta content="1" name="dtb:depth"/>\n        <meta content="0" name="dtb:totalPageCount"/>\n        <meta content="0" name="dtb:maxPageNumber"/>\n    </head>\n    <docTitle>\n        <text>'+book.title+"</text>\n    </docTitle>\n    <docAuthor>\n        <text>"+book.author+"</text>\n    </docAuthor>\n    <navMap>\n        "+function(){var i,len,ref,results;for(ref=book.chapters,results=[],key=i=0,len=ref.length;len>i;key=++i)chapter=ref[key],results.push(this.chapter_to_navpoint(key,chapter));return results}.call(this).join("\n")+"\n    </navMap>\n</ncx>",this.handler.file("OEBPS/toc.ncx",file)},this.chapter_to_navpoint=function(id,chapter){return'<navPoint id="navpoint-'+id+'" playOrder="'+id+'">\n    <navLabel>\n        <text>'+chapter.name+'</text>\n    </navLabel>\n    <content src="text/'+chapter.slug+".xhtml#"+chapter.slug+'"/>\n</navPoint>'},this.add_content_file=function(book){var chapter,file;return file='<?xml version="1.0" encoding="UTF-8"?>\n<package xmlns="http://www.idpf.org/2007/opf" version="3.0" xml:lang="'+book.locale+'" unique-identifier="ean" prefix="cc: http://creativecommons.org/ns#">\n    <metadata xmlns:dc="http://purl.org/dc/elements/1.1/" xmlns:opf="http://www.idpf.org/2007/opf">\n        <meta name="fixed-layout" content="false" />\n        <meta name="cover" content="cover.png" />\n        <dc:identifier id="ean">'+book.ean+"</dc:identifier>\n        <dc:language>"+book.locale+'</dc:language>\n        <dc:title id="title">'+book.title+"</dc:title>\n        <dc:creator>"+book.author+"</dc:creator>\n        <dc:publisher>"+book.publisher+"</dc:publisher>\n        <dc:description>"+book.description+"</dc:description>\n        <dc:date>"+book.date+'</dc:date>\n        <meta property="dcterms:modified">'+book.date+'</meta>\n        <meta property="rendition:layout">pre-paginated</meta>\n        <meta property="rendition:spread">none</meta>\n        <meta property="rendition:orientation">portrait</meta>\n    </metadata>\n    <manifest>\n        '+function(){var i,len,ref,results;for(ref=book.chapters,results=[],i=0,len=ref.length;len>i;i++)chapter=ref[i],results.push(this.chapter_to_manifest_item(chapter));return results}.call(this).join("\n")+'\n        <item href="toc.ncx" id="ncx" media-type="application/x-dtbncx+xml" />\n        <item href="text/toc.xhtml" id="toc" media-type="application/xhtml+xml" properties="nav" />\n        <item href="images/cover.png" id="cover.png" media-type="image/png" />\n    </manifest>\n    <spine toc="ncx" page-progression-direction="ltr">\n        '+function(){var i,len,ref,results;for(ref=book.chapters,results=[],i=0,len=ref.length;len>i;i++)chapter=ref[i],results.push(this.chapter_to_spine_item(chapter));return results}.call(this).join("\n")+"\n    </spine>\n</package>",this.handler.file("OEBPS/content.opf",file)},this.chapter_to_manifest_item=function(chapter){return'<item href="text/'+chapter.slug+'.xhtml" id="'+chapter.slug+'" media-type="application/xhtml+xml" />'},this.chapter_to_spine_item=function(chapter){return'<itemref idref="'+chapter.slug+'" />'},this.chapter_to_summary_item=function(chapter){return"<ol>"+chapter.name+"</ol>"},this.chapter_to_file=function(book,chapter){var file;return file='<?xml version="1.0" encoding="utf-8"?>\n<!DOCTYPE html>\n<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="fr-FR">\n    <head>\n        <meta content="width=device-width, height=device-height" name="viewport" />\n        <title>'+chapter.name+" - "+book.title+'</title>\n    </head>\n    <body id="'+chapter.slug+'">\n        '+chapter.content+"\n    </body>\n</html>",$("<textarea />").html(file).text()},this.add_chapters=function(book){var chapter,i,len,ref,results;for(ref=book.chapters,results=[],i=0,len=ref.length;len>i;i++)chapter=ref[i],results.push(this.handler.file("OEBPS/text/"+chapter.slug+".xhtml",this.chapter_to_file(book,chapter)));return results},this.add_summary=function(book){var chapter,file;return file='<?xml version="1.0" encoding="utf-8"?>\n<!DOCTYPE html>\n<html xmlns="http://www.w3.org/1999/xhtml" xmlns:epub="http://www.idpf.org/2007/ops" xml:lang="fr-FR">\n    <head>\n        <meta content="width=device-width, height=device-height" name="viewport" />\n        <title>Index</title>\n    </head>\n    <body>\n        <header>\n            <h1>Index</h1>\n        </header>\n        <nav epub:type="toc" id="toc">\n            '+function(){var i,len,ref,results;for(ref=book.chapters,results=[],i=0,len=ref.length;len>i;i++)chapter=ref[i],results.push(this.chapter_to_summary_item(chapter));return results}.call(this).join("\n")+"\n        </nav>\n    </body>\n</html>",this.handler.file("OEBPS/text/toc.xhtml",file)},this.read_file=function(file){var q,reader;return q=$q.defer(),reader=new FileReader,reader.onload=function(e){var data;return data=e.target.result,q.resolve(data)},reader.readAsDataURL(file),q.promise},this.read_image=function(src){var image,q;return q=$q.defer(),image=new Image,image.onload=function(){var c,ctx;return c=document.createElement("canvas"),c.width=image.width,c.height=image.height,ctx=c.getContext("2d"),ctx.drawImage(image,0,0),q.resolve(c.toDataURL("image/png"))},image.src=src,q.promise},this.publish=function(book,output){return this.handler=new JSZip,this.add_mimetype_file(),this.add_container_file(),this.add_map_file(book),this.add_summary(book),this.add_content_file(book),this.read_file(book.cover[0]).then(function(_this){return function(data_uri){return _this.read_image(data_uri).then(function(data){var content;return _this.handler.file("OEBPS/images/cover.png",data.replace("data:image/png;base64,",""),{base64:!0}),_this.add_chapters(book),content=_this.handler.generate({type:"blob"}),saveAs(content,output),_this.handler=null})}}(this))},this})}).call(this);